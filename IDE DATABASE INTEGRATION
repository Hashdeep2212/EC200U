#include <HardwareSerial.h>
#include <Wire.h>
#include <Adafruit_MPU6050.h>
#include <Adafruit_Sensor.h>
#include <math.h>

/* ================= PIN DEFINITIONS ================= */
#define GSM_STAT_PIN   34
#define GSM_PWRKEY_PIN 33
#define GSM_RX         14
#define GSM_TX         13

#define SDA_PIN        15
#define SCL_PIN        4

#define FLAME_PIN      35
#define MQ5_PIN        32
#define SWITCH_PIN     27
#define BUZZER_PIN     12

/* ================= SUPABASE CONFIG ================= */
#define SUPABASE_URL  "https://bsmmpbkvdvwvtuzvzatx.supabase.co"
#define SUPABASE_HOST "bsmmpbkvdvwvtuzvzatx.supabase.co"
#define SUPABASE_KEY  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzbW1wYmt2ZHZ3dnR1enZ6YXR4Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzY4ODE1MSwiZXhwIjoyMDgzMjY0MTUxfQ.7YyJb2BChRep6As75YKCU4r6nQxkfFijfemi9JN99a0"
#define TABLE_NAME "vessel"
#define VESSEL_ID  69420

/* ================= HARDCODED GPS ================= */
#define USE_HARDCODED_GPS true

const float FIXED_LAT = 18.5852368;
const float FIXED_LON = 73.7376059;

/* ================= GLOBAL OBJECTS ================= */
HardwareSerial SerialAT(2);
Adafruit_MPU6050 mpu;

/* ================= GLOBAL STATE ================= */
float lastLat = 0.0;
float lastLon = 0.0;
float lastSpeed = 0.0;
float lastDirection = 0.0;

/* ================= RANDOM SPEED ================= */
float randomSpeed() {
  return random(20, 180) / 10.0;   // 2.0 â€“ 18.0 km/h
}

/* ================= STATUS PRINT ================= */
void printSystemStatus(
  float lat, float lon,
  float speed, float direction,
  int mq5, bool flame,
  float pitch, float roll,
  bool sos
) {
  Serial.println("â•â•â•â•â•â•â•â•â•â• VESSEL STATUS â•â•â•â•â•â•â•â•â•â•");
  Serial.printf("ğŸ“¡ GPS     : %.6f , %.6f\n", lat, lon);
  Serial.printf("ğŸ§­ Speed   : %.2f km/h\n", speed);
  Serial.printf("ğŸ§­ Course  : %.2f deg\n", direction);
  Serial.printf("ğŸ§ª MQ5     : %d\n", mq5);
  Serial.printf("ğŸ”¥ Flame   : %s\n", flame ? "DETECTED" : "SAFE");
  Serial.printf("ğŸ“ Pitch   : %.2f deg\n", pitch);
  Serial.printf("ğŸ“ Roll    : %.2f deg\n", roll);
  Serial.printf("ğŸš¨ SOS     : %s\n", sos ? "ACTIVE" : "OFF");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

/* ================= MODEM POWER ================= */
void modemPowerOn() {
  pinMode(GSM_PWRKEY_PIN, OUTPUT);
  pinMode(GSM_STAT_PIN, INPUT);

  if (digitalRead(GSM_STAT_PIN)) return;

  digitalWrite(GSM_PWRKEY_PIN, HIGH);
  delay(2200);
  digitalWrite(GSM_PWRKEY_PIN, LOW);
  delay(6000);
}

/* ================= WAIT RESPONSE ================= */
bool waitForResponse(String expected, unsigned long timeout) {
  unsigned long start = millis();
  String response = "";
  while (millis() - start < timeout) {
    if (SerialAT.available()) {
      response += (char)SerialAT.read();
      if (response.indexOf(expected) != -1) return true;
    }
  }
  return false;
}

/* ================= SUPABASE UPLOAD ================= */
void sendToSupabase(
  float lat, float lon,
  float speed, float direction,
  int mq5, bool flame,
  float pitch, float roll,
  bool sos
) {
  String jsonData = "{";
  jsonData += "\"vessel_id\":" + String(VESSEL_ID) + ",";
  jsonData += "\"lat\":" + String(lat, 6) + ",";
  jsonData += "\"long\":" + String(lon, 6) + ",";
  jsonData += "\"active\":true,";
  jsonData += "\"sos\":" + String(sos ? "true" : "false") + ",";
  jsonData += "\"speed\":" + String(speed, 2) + ",";
  jsonData += "\"direction\":" + String(direction, 2) + ",";
  jsonData += "\"mq5_raw\":" + String(mq5) + ",";
  jsonData += "\"flame\":" + String(flame ? "true" : "false") + ",";
  jsonData += "\"tilt_level\":" + String(roll, 2) + ",";
  jsonData += "\"pitch_angle\":" + String(pitch, 2);
  jsonData += "}";

  String postData =
    "POST /rest/v1/" + String(TABLE_NAME) + " HTTP/1.1\r\n" +
    "Host: " SUPABASE_HOST "\r\n" +
    "apikey: " SUPABASE_KEY "\r\n" +
    "Authorization: Bearer " SUPABASE_KEY "\r\n" +
    "Content-Type: application/json\r\n" +
    "Content-Length: " + String(jsonData.length()) + "\r\n\r\n" +
    jsonData;

  Serial.println("â˜ï¸ Uploading to Cloud...");

  SerialAT.println("AT+QHTTPCFG=\"requestheader\",1");
  waitForResponse("OK", 1000);

  SerialAT.println("AT+QHTTPURL=" + String(strlen(SUPABASE_URL)));
  if (!waitForResponse("CONNECT", 3000)) return;
  SerialAT.print(SUPABASE_URL);
  waitForResponse("OK", 3000);

  SerialAT.println("AT+QHTTPPOST=" + String(postData.length()));
  if (!waitForResponse("CONNECT", 5000)) return;
  SerialAT.print(postData);

  if (waitForResponse("+QHTTPPOST:", 10000))
    Serial.println("âœ… Upload Success");
  else
    Serial.println("âŒ Upload Failed");
}

/* ================= SETUP ================= */
void setup() {
  Serial.begin(115200);
  randomSeed(micros());

  Wire.begin(SDA_PIN, SCL_PIN);

  pinMode(FLAME_PIN, INPUT);
  pinMode(MQ5_PIN, INPUT);
  pinMode(SWITCH_PIN, INPUT_PULLUP);
  pinMode(BUZZER_PIN, OUTPUT);

  if (!mpu.begin()) while (1);

  modemPowerOn();
  SerialAT.begin(115200, SERIAL_8N1, GSM_RX, GSM_TX);
  delay(2000);

  SerialAT.println("AT");
  waitForResponse("OK", 1000);

  SerialAT.println("AT+QICSGP=1,1,\"airtelgprs.com\",\"\",\"\",1");
  waitForResponse("OK", 3000);

  SerialAT.println("AT+QIACT=1");
  waitForResponse("OK", 5000);

  Serial.println("âœ… SYSTEM READY (HARDCODED GPS)");
}

/* ================= LOOP ================= */
void loop() {
  bool flame = digitalRead(FLAME_PIN) == LOW;
  bool sos   = digitalRead(SWITCH_PIN) == LOW;
  int mq5    = analogRead(MQ5_PIN);

  sensors_event_t a, g, t;
  mpu.getEvent(&a, &g, &t);

  float pitch = atan2(a.acceleration.x,
                sqrt(pow(a.acceleration.y,2) + pow(a.acceleration.z,2))) * 180 / M_PI;
  float roll  = atan2(a.acceleration.y,
                sqrt(pow(a.acceleration.x,2) + pow(a.acceleration.z,2))) * 180 / M_PI;

  digitalWrite(BUZZER_PIN, (flame || sos));

  if (USE_HARDCODED_GPS) {
    lastLat = FIXED_LAT;
    lastLon = FIXED_LON;
    lastSpeed = randomSpeed();
    lastDirection = random(0, 360);
  }

  printSystemStatus(
    lastLat, lastLon,
    lastSpeed, lastDirection,
    mq5, flame,
    pitch, roll,
    sos
  );

  sendToSupabase(
    lastLat, lastLon,
    lastSpeed, lastDirection,
    mq5, flame,
    pitch, roll,
    sos
  );

  delay(2000);
}
